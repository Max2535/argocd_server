#!/bin/bash

# =============================================================================
# ЁЯФС р╕Фр╕╢р╕Зр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ ArgoCD Admin
# =============================================================================

# р╕кр╕╡р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕кр╕Фр╕Зр╕Ьр╕е
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }

echo "ЁЯФС р╕Фр╕╢р╕Зр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ ArgoCD Admin"
echo "================================"

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ kubectl р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if ! command -v kubectl >/dev/null 2>&1; then
    error "р╣Др╕бр╣Ир╕Юр╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З kubectl р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕Бр╣Ир╕нр╕Щр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ"
    exit 1
fi

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З Kubernetes cluster р╣Др╕Фр╣Йр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if ! kubectl cluster-info >/dev/null 2>&1; then
    error "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕З Kubernetes cluster р╣Др╕Фр╣Й"
    error "р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ kubeconfig р╕лр╕гр╕╖р╕нр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ cluster"
    exit 1
fi

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ namespace argocd
if ! kubectl get namespace argocd >/dev/null 2>&1; then
    error "р╣Др╕бр╣Ир╕Юр╕Ъ namespace argocd"
    error "р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Др╕Фр╣Йр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З ArgoCD р╣Бр╕ер╣Йр╕з"
    exit 1
fi

# р╕Юр╕вр╕▓р╕вр╕▓р╕бр╕Фр╕╢р╕Зр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╕Ир╕▓р╕Б secret
log "р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕╢р╕Зр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ admin р╕Ир╕▓р╕Б secret..."

# р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Кр╕╖р╣Ир╕н secret р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З (р╕бр╕╡р╕лр╕ер╕▓р╕вр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Чр╕╡р╣Ир╕нр╕▓р╕Ир╣Гр╕Кр╣Й)
possible_secrets=("argocd-initial-admin-password" "argocd-initial-admin-secret")
admin_password=""

for secret_name in "${possible_secrets[@]}"; do
    log "р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ secret '$secret_name'..."
    password=$(kubectl -n argocd get secret $secret_name -o jsonpath="{.data.password}" 2>/dev/null | base64 -d 2>/dev/null)
    
    if [ -n "$password" ]; then
        admin_password="$password"
        log "тЬЕ р╕Юр╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ admin р╣Гр╕Щ secret '$secret_name'"
        break
    fi
done

# р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Юр╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Гр╕Щр╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕З secret р╕ер╕нр╕Зр╕зр╕┤р╕Шр╕╡р╕нр╕╖р╣Ир╕Щ
if [ -z "$admin_password" ]; then
    warn "тЪая╕П р╣Др╕бр╣Ир╕Юр╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Гр╕Щ secret р╕Чр╕▒р╣Ир╕зр╣Др╕Ы"
    
    # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ ArgoCD р╕Цр╕╣р╕Бр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕бр╕▓р╕Щр╕▓р╕Щр╣Бр╕ер╣Йр╕зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    argocd_created=$(kubectl get -n argocd deployment argocd-server -o jsonpath="{.metadata.creationTimestamp}" 2>/dev/null)
    if [ -n "$argocd_created" ]; then
        creation_date=$(date -d "$argocd_created" +"%Y-%m-%d" 2>/dev/null || echo "$argocd_created")
        warn "ArgoCD р╕Цр╕╣р╕Бр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Ар╕бр╕╖р╣Ир╕н: $creation_date"
        warn "Secret р╕нр╕▓р╕Ир╕Цр╕╣р╕Бр╕ер╕Ър╣Др╕Ыр╣Бр╕ер╣Йр╕зр╣Ар╕Щр╕╖р╣Ир╕нр╕Зр╕Ир╕▓р╕Бр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕бр╕▓р╕Щр╕▓р╕Щ"
    fi
    
    # р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Юр╕Ъ secret р╣Бр╕Хр╣И ArgoCD р╕вр╕▒р╕Зр╕Чр╕│р╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣И р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╣Гр╕Кр╣Й reset-admin-password.sh
    if kubectl get -n argocd deployment argocd-server >/dev/null 2>&1; then
        warn "ArgoCD р╕Бр╕│р╕ер╕▒р╕Зр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕Хр╣Ир╣Др╕бр╣Ир╕Юр╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ"
        echo ""
        echo "р╕кр╕▓р╣Ар╕лр╕Хр╕╕р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╣Др╕Ыр╣Др╕Фр╣Й:"
        echo "1. ArgoCD р╕нр╕▓р╕Ир╕Цр╕╣р╕Бр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕бр╕▓р╕Щр╕▓р╕Щр╣Бр╕ер╣Йр╕зр╣Бр╕ер╕░ secret р╕Цр╕╣р╕Бр╕ер╕Ър╣Др╕Ыр╣Бр╕ер╣Йр╕з"
        echo "2. р╕бр╕╡р╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕Зр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ admin р╣Бр╕ер╣Йр╕з"
        echo "3. ArgoCD р╕нр╕▓р╕Ир╕Цр╕╣р╕Бр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕Фр╣Йр╕зр╕вр╕зр╕┤р╕Шр╕╡р╕Чр╕╡р╣Ир╣Др╕бр╣Ир╣Др╕Фр╣Йр╕кр╕гр╣Йр╕▓р╕З secret р╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ"
        echo ""
        warn "р╕лр╕▓р╕Бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ admin р╕Бр╕гр╕╕р╕Ур╕▓р╣Гр╕Кр╣Й:"
        echo "  ./reset-admin-password.sh"
        exit 1
    else
        error "тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З ArgoCD р╕Чр╕╡р╣Ир╕Чр╕│р╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣И"
        error "р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З ArgoCD р╕Бр╣Ир╕нр╕Щ"
        exit 1
    fi
fi

# р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ
echo ""
echo "ЁЯСд Username: admin"
echo "ЁЯФС Password: $admin_password"
echo ""
log "тЬЕ р╕Бр╕▓р╕гр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ"
